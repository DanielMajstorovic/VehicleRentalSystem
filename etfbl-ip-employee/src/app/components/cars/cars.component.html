<div class="container-fluid">
    <h3 class="fw-bold">Cars Management</h3>

    <div class="d-flex justify-content-between align-items-center mt-3 mb-3">
        <div>
            <div class="input-group me-2 d-inline-flex align-items-center" style="vertical-align: middle;">
                <input type="text" class="form-control" placeholder="Search..." [(ngModel)]="searchTerm"
                    (keyup.enter)="onSearch()" />
                <button class="btn btn-primary" (click)="onSearch()">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </div>

        <div>
            <button class="btn btn-secondary me-2" (click)="csvFileInput.click()">
                <i class="fas fa-file-csv"></i> Upload CSV
            </button>
            <input #csvFileInput type="file" class="d-none" accept=".csv, .txt" (change)="onCsvFileSelected($event)" />

            <button class="btn btn-success" (click)="openCreateCarModal()">
                <i class="bi bi-plus-lg"></i> New Car
            </button>
        </div>
    </div>

    <div class="table-responsive bg-white rounded shadow-sm">
        <table class="table table-striped mb-0">
            <thead class="thead-dark">
                <tr>
                    <th scope="col">UID</th>
                    <th scope="col">Manufacturer</th>
                    <th scope="col">Model</th>
                    <th scope="col">Purchase Price</th>
                    <th scope="col">Price/Day</th>
                    <th scope="col">Status</th>
                    <th scope="col" style="width: 80px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let car of cars">
                    <td>{{ car.vehicleUid }}</td>
                    <td>
                        {{ car.vehicleManufacturerName }}
                        <span *ngIf="car.vehicleManufacturerCountry">
                            ({{ car.vehicleManufacturerCountry }})
                        </span>
                    </td>
                    <td>{{ car.vehicleModel }}</td>

                    <td>{{ car.vehiclePurchasePrice | currency:'USD' }}</td>

                    <td>
                        {{ (car.vehiclePricePerSecond * 86400) | currency:'USD' }}
                    </td>

                    <td>{{ car.vehicleStatus }}</td>
                    <td>
                        <div style="display: flex; flex-direction: row; justify-content: space-between;">
                            <button class="btn btn-sm btn-outline-secondary me-1" (click)="onViewCarDetails(car.id)"
                                title="View details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" (click)="onDeleteCar(car.id, car.vehicleUid)"
                                title="Delete car">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                <tr *ngIf="cars && cars.length === 0">
                    <td colspan="7" class="text-center text-muted">
                        No cars found.
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-2">
        <div>
            <small>
                Showing page {{ currentPage + 1 }} of {{ totalPages }} â€“
                Total items: {{ totalElements }}
            </small>
        </div>
        <div>
            <button class="btn btn-outline-secondary btn-sm me-1" [disabled]="currentPage === 0"
                (click)="goToPage(currentPage - 1)">
                <i class="bi bi-chevron-left"></i> Prev
            </button>
            <button class="btn btn-outline-secondary btn-sm" [disabled]="currentPage >= totalPages - 1"
                (click)="goToPage(currentPage + 1)">
                Next <i class="bi bi-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<div class="modal fade" tabindex="-1" role="dialog" [ngClass]="{'show d-block': showCreateModal}"
    *ngIf="showCreateModal" aria-labelledby="createCarModalLabel" aria-modal="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createCarModalLabel">Create New Car</h5>
                <button type="button" class="btn-close" aria-label="Close" (click)="closeCreateCarModal()"></button>
            </div>

            <div class="modal-body">
                <form [formGroup]="createCarForm" novalidate>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="vehicleUid" class="form-label fw-bold">Vehicle UID</label>
                            <input type="text" id="vehicleUid" class="form-control" formControlName="vehicleUid"
                                [ngClass]="{'is-invalid': isInvalidField('vehicleUid')}" />
                            <div class="invalid-feedback" *ngIf="isInvalidField('vehicleUid')">
                                Vehicle UID is required.
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="vehicleModel" class="form-label fw-bold">Model</label>
                            <input type="text" id="vehicleModel" class="form-control" formControlName="vehicleModel"
                                [ngClass]="{'is-invalid': isInvalidField('vehicleModel')}" />
                            <div class="invalid-feedback" *ngIf="isInvalidField('vehicleModel')">
                                Model is required.
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="vehicleManufacturerId" class="form-label fw-bold">Manufacturer</label>
                            <select id="vehicleManufacturerId" class="form-select"
                                formControlName="vehicleManufacturerId"
                                [ngClass]="{'is-invalid': isInvalidField('vehicleManufacturerId')}">
                                <option value="" disabled selected>-- Select Manufacturer --</option>
                                <option *ngFor="let m of manufacturers" [value]="m.id">
                                    {{ m.name }} ({{ m.country }})
                                </option>
                            </select>
                            <div class="invalid-feedback" *ngIf="isInvalidField('vehicleManufacturerId')">
                                Manufacturer is required.
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="vehiclePurchasePrice" class="form-label fw-bold">Purchase Price (USD)</label>
                            <input type="number" id="vehiclePurchasePrice" class="form-control"
                                formControlName="vehiclePurchasePrice"
                                [ngClass]="{'is-invalid': isInvalidField('vehiclePurchasePrice')}" />
                            <div class="invalid-feedback" *ngIf="isInvalidField('vehiclePurchasePrice')">
                                Purchase price is required.
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="vehiclePricePerDay" class="form-label fw-bold">Price per day (USD)</label>
                            <input type="number" id="vehiclePricePerDay" class="form-control"
                                formControlName="vehiclePricePerDay"
                                [ngClass]="{'is-invalid': isInvalidField('vehiclePricePerDay')}" />
                            <div class="invalid-feedback" *ngIf="isInvalidField('vehiclePricePerDay')">
                                Daily price is required.
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="purchaseDate" class="form-label fw-bold">Purchase Date</label>
                            <input type="date" id="purchaseDate" class="form-control" formControlName="purchaseDate"
                                [ngClass]="{'is-invalid': isInvalidField('purchaseDate')}" />
                            <div class="invalid-feedback" *ngIf="isInvalidField('purchaseDate')">
                                Purchase date is required.
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label fw-bold">Description</label>
                        <input type="text" id="description" class="form-control" formControlName="description"
                            [ngClass]="{'is-invalid': isInvalidField('description')}" />
                        <div class="invalid-feedback" *ngIf="isInvalidField('description')">
                            Description is required.
                        </div>
                    </div>

                    <label class="form-label fw-bold">Location</label>
                    <div #map id="map" style="height: 300px; border: 1px solid #ccc; margin-bottom: 1rem;"></div>

                    <input type="hidden" formControlName="vehicleX" />
                    <input type="hidden" formControlName="vehicleY" />

                    <div class="mb-3">
                        <label for="imageUpload" class="form-label fw-bold">Image</label>
                        <input type="file" id="imageUpload" class="form-control" (change)="onImageSelected($event)" />
                        <div class="text-danger mt-1" *ngIf="imageError">
                            {{ imageError }}
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" (click)="closeCreateCarModal()">
                    Close
                </button>
                <button type="button" class="btn btn-primary" (click)="onCreateCar()">
                    Create
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal-backdrop fade show" *ngIf="showCreateModal" (click)="closeCreateCarModal()"></div>